<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MauiStrides.ViewModels"
             xmlns:models="clr-namespace:MauiStrides.Models"
             x:Class="MauiStrides.Views.ActivitiesPage"
             x:Name="ThisPage" 
             Title=""
             BackgroundColor="{StaticResource AppBackground}">

    <Grid RowDefinitions="Auto, Auto, *">

        <VerticalStackLayout Grid.Row="0" Padding="12" Spacing="12">
            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                <Label Text="Activities" 
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="{StaticResource AppText}"
                       VerticalOptions="Center"
                       LineBreakMode="NoWrap"/>

                <Border Grid.Column="1" 
                        StrokeShape="RoundRectangle 22" 
                        HeightRequest="44" 
                        WidthRequest="44" 
                        StrokeThickness="0"
                        BindingContext="{Binding Source={x:Reference ThisPage}, Path=ProfileViewModel}">
                    <Image Source="{Binding CurrentAthleteProfile.ProfileMedium}" Aspect="AspectFill">
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToProfileCommand}" />
                        </Image.GestureRecognizers>
                    </Image>
                </Border>
            </Grid>

            <Border StrokeShape="RoundRectangle 10" StrokeThickness="0" 
                    BackgroundColor="{StaticResource AppSurface}" Padding="8,0">
                <SearchBar Placeholder="Search for activities..." 
                           TextColor="{StaticResource AppText}"
                           PlaceholderColor="{StaticResource AppSecondary}"
                           Text="{Binding SearchText}"
                           FontSize="14"/>
            </Border>
        </VerticalStackLayout>

        <ScrollView Grid.Row="1" Orientation="Horizontal" 
                    HorizontalScrollBarVisibility="Never" 
                    Padding="12,0,12,10">
            <HorizontalStackLayout Spacing="6">
                
                <!-- "Alla" Filter Button -->
                <Button Text="All" 
                        Command="{Binding ApplyFilterCommand}" 
                        CommandParameter="All"
                        FontSize="12"
                        Padding="10,0"
                        CornerRadius="18"
                        HeightRequest="36"
                        BorderWidth="1">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding SelectedFilter}"
                                     Value="All">
                            <Setter Property="BackgroundColor" Value="{StaticResource AppPrimary}" />
                            <Setter Property="TextColor" Value="White" />
                            <Setter Property="BorderColor" Value="{StaticResource AppPrimary}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <!-- "Run" Filter Button -->
                <Button Text="Run" 
                        Command="{Binding ApplyFilterCommand}" 
                        CommandParameter="Run"
                        FontSize="12"
                        Padding="10,0"
                        CornerRadius="18"
                        HeightRequest="36"
                        BorderWidth="1">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding SelectedFilter}"
                                     Value="Run">
                            <Setter Property="BackgroundColor" Value="{StaticResource AppPrimary}" />
                            <Setter Property="TextColor" Value="White" />
                            <Setter Property="BorderColor" Value="{StaticResource AppPrimary}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <!-- "Ride" Filter Button -->
                <Button Text="Ride" 
                        Command="{Binding ApplyFilterCommand}" 
                        CommandParameter="Ride"
                        FontSize="12"
                        Padding="10,0"
                        CornerRadius="18"
                        HeightRequest="36"
                        BorderWidth="1">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding SelectedFilter}"
                                     Value="Ride">
                            <Setter Property="BackgroundColor" Value="{StaticResource AppPrimary}" />
                            <Setter Property="TextColor" Value="White" />
                            <Setter Property="BorderColor" Value="{StaticResource AppPrimary}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <!-- "Virtual Ride" Filter Button -->
                <Button Text="VRide" 
                        Command="{Binding ApplyFilterCommand}" 
                        CommandParameter="VirtualRide"
                        FontSize="12"
                        Padding="10,0"
                        CornerRadius="18"
                        HeightRequest="36"
                        BorderWidth="1">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding SelectedFilter}"
                                     Value="VirtualRide">
                            <Setter Property="BackgroundColor" Value="{StaticResource AppPrimary}" />
                            <Setter Property="TextColor" Value="White" />
                            <Setter Property="BorderColor" Value="{StaticResource AppPrimary}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

            </HorizontalStackLayout>
        </ScrollView>

        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding Activities}"
                        SelectionMode="Single"
                        SelectionChangedCommand="{Binding GoToDetailsCommand}"
                        SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}"
                        RemainingItemsThreshold="5"
                        RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Activity">
                    <Grid Padding="12,4">
                        <Border Style="{StaticResource ActivityCardStyle}" Padding="12">
                            <Grid ColumnDefinitions="Auto, *, Auto" 
                                  RowDefinitions="Auto, Auto" 
                                  ColumnSpacing="10">

                                <Border Grid.RowSpan="2" 
                                        HeightRequest="38"
                                        WidthRequest="38"
                                        StrokeShape="RoundRectangle 19"
                                        BackgroundColor="{StaticResource AppBackground}"
                                        StrokeThickness="0"
                                        VerticalOptions="Center">
                                    <Label Text="{Binding SportIcon}" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center" 
                                           FontSize="16"/>
                                </Border>

                                <VerticalStackLayout Grid.Column="1" Grid.Row="0" Spacing="2">
                                    <Label Text="{Binding Name}" 
                                           FontAttributes="Bold" 
                                           FontSize="14" 
                                           TextColor="{StaticResource AppText}" 
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1"/>
                                    <Label Text="{Binding StartDate, StringFormat='{0:dd MMM â€¢ HH:mm}'}" 
                                           FontSize="11" 
                                           TextColor="{StaticResource AppSecondary}"/>
                                </VerticalStackLayout>

                                <HorizontalStackLayout Grid.Column="1" Grid.Row="1" 
                                                       Spacing="8" 
                                                       Margin="0,4,0,0">
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="&#xED5C;" 
                                               FontFamily="Segoe Fluent Icons"
                                               FontSize="13"
                                               TextColor="{StaticResource AppText}"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding DistanceKm}" 
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource AppText}"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>

                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="&#xE917;" 
                                               FontFamily="Segoe Fluent Icons"
                                               FontSize="13"
                                               TextColor="{StaticResource AppText}"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding TimeDisplay}" 
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource AppText}"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                </HorizontalStackLayout>

                                <Label Grid.Column="2" Grid.RowSpan="2" 
                                       Text="&#xE76C;" 
                                       FontFamily="Segoe Fluent Icons"
                                       FontSize="14"
                                       TextColor="{StaticResource AppSecondary}"
                                       VerticalOptions="Center"/>

                            </Grid>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.Footer>
                <StackLayout Padding="20" IsVisible="{Binding IsFooterLoading}">
                    <ActivityIndicator IsRunning="True" 
                                       Color="{StaticResource AppPrimary}" 
                                       HorizontalOptions="Center"/>
                </StackLayout>
            </CollectionView.Footer>

        </CollectionView>
    </Grid>

</ContentPage>